image: node:14.15.1

cache:
  key: "$CI_BUILD_REF_NAME"
  paths:
    - .yarn/
    - node_modules/
    - packages/*/node_modules/*
    - .jestcache/
    - .eslintcache
    - .stylelintcache

stages:
  - setup
  - quality
  - build

setup:
  stage: setup
  script:
    - yarn install --cache-folder .yarn --frozen-lockfile
    - yarn lernabootstrap:ci

linting:
  stage: quality
  script:
    -  yarn lint

test:
  stage: quality
  script:
    -  yarn test --maxWorkers=4 --silent --verbose false
  after_script:
    - yarn codecov

storybook:
  stage: quality
  script:
    - BACKEND=https://master.tocco.ch yarn build-storybook
    - chmod +x deployment/deploy_storybook_gitlab.sh
    - deployment/deploy_storybook_gitlab.sh
