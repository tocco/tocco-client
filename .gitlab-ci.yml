image: node:14.15.1

cache:
  key: "$CI_COMMIT_REF_NAME"
  paths:
    - node_modules/
    - packages/*/node_modules/
    - .jestcache/
    - .eslintcache
    - .stylelintcache

before_script:
  - yarn setup:ci

stages:
  - quality
  - build
  - pullrequest
  - onschedule

linting:
  stage: quality
  script:
    -  yarn lint

test:
  stage: quality
  script:
    - yarn test --ci --forceExit --runInBand --detectOpenHandles
  after_script:
    - yarn codecov

storybook:
  stage: quality
  cache: {
    policy: pull
  }
  script:
    - BACKEND=https://master.tocco.ch yarn build-storybook
    - deployment/deploy_storybook_gitlab.sh

storybook-link:
  stage: pullrequest
  cache: {}
  before_script:
    - ''
  only:
    - external_pull_requests
  script:
    - apt-get update && apt-get install -y jq
    - deployment/storybook_link_gitlab.sh

cypress:
  stage: onschedule
  cache: {}
  only:
    - schedules
  script:
    - yarn cypress:master:record --parallel
